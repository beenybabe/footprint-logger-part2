<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f5f5f5;}
    .card { background:white; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:12px;}
  </style>
</head>
<body>
  <h1>Your Dashboard</h1>
  <button id="logout">Logout</button>

  <div class="card">
    <h3>Add activity</h3>
    <input id="activityType" placeholder="Activity e.g. car" />
    <input id="category" placeholder="Category e.g. transport" />
    <input id="co2" placeholder="CO2 (kg)" type="number" />
    <button id="add">Add</button>
  </div>

  <div class="card">
    <h3>Recent logs</h3>
    <table id="logs" border="1"></table>
    <p>Total: <span id="total">0</span> kg CO2</p>
  </div>

  <div class="card">
    <h3>Weekly Summary</h3>
    <canvas id="weeklyChart"></canvas>
  </div>

  <div class="card">
    <h3>Community</h3>
    <div id="community"></div>
  </div>

  <div class="card">
    <h3>Leaderboard (low avg daily CO2)</h3>
    <div id="leaderboard"></div>
  </div>

<script>
const api = '/api';
const token = () => localStorage.getItem('token');
if (!token()) window.location = '/';

async function apiFetch(path, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers['Content-Type'] = 'application/json';
  opts.headers['Authorization'] = 'Bearer ' + token();
  const res = await fetch(api + path, opts);
  return res;
}

async function loadLogs() {
  const res = await apiFetch('/activities');
  const data = await res.json();
  if (!res.ok) { alert(data.message || 'error'); return; }
  const tbl = document.getElementById('logs');
  tbl.innerHTML = '<tr><th>Activity</th><th>Category</th><th>CO2</th><th>Date</th></tr>';
  data.activities.forEach(a => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${a.activityType}</td><td>${a.category}</td><td>${a.co2}</td><td>${new Date(a.date).toLocaleString()}</td>`;
    tbl.appendChild(row);
  });
  document.getElementById('total').textContent = data.total.toFixed(2);

  // weekly chart
  const wRes = await apiFetch('/activities/stats/weekly?weeks=6');
  const wData = await wRes.json();
  const labels = wData.weeks.map(w => `W${w._id.week}-${w._id.year}`);
  const totals = wData.weeks.map(w => w.total);
  const ctx = document.getElementById('weeklyChart').getContext('2d');
  new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'kg CO2', data: totals }] } });
}

document.getElementById('add').addEventListener('click', async () => {
  const activityType = document.getElementById('activityType').value || 'custom';
  const category = document.getElementById('category').value || 'other';
  const co2 = parseFloat(document.getElementById('co2').value || '0');
  const res = await apiFetch('/activities', { method: 'POST', body: JSON.stringify({ activityType, category, co2 }) });
  const data = await res.json();
  if (res.ok) {
    loadLogs();
  } else alert(data.message || JSON.stringify(data));
});

document.getElementById('logout').addEventListener('click', () => { localStorage.removeItem('token'); window.location = '/'; });

async function loadCommunityAndLeaderboard() {
  const st = await apiFetch('/activities/stats/dashboard');
  const stj = await st.json();
  document.getElementById('community').innerText = `Avg per user: ${ (stj.community.avgPerUser || 0).toFixed(2)} kg CO2`;

  const lb = await apiFetch('/activities/leaderboard?limit=10');
  const lbj = await lb.json();
  const node = document.getElementById('leaderboard');
  node.innerHTML = lbj.leaderboard.map(u => `<div>${u.user.displayName || u.user.email}: ${u.avgDaily.toFixed(2)} kg/day</div>`).join('');
}

loadLogs();
loadCommunityAndLeaderboard();
</script>
</body>
</html>
